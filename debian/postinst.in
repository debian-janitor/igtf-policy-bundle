#!/bin/sh
# postinst script for igtf-policy-@PROFILE@
#
# see: dh_installdeb(1)

set -e

. /usr/share/debconf/confmodule

# auxiliary function to find $1 in $2
in_list() {
    local i
    local s=$1
    shift
    for i in "$@" ; do
	if test "$s" = "$i" ; then
	    return 0
	fi
    done
    return 1
}


# check if $1 is supposed to be included.
ca_included() {
    if [ "$install_profile" = true ]; then
	if in_list "$1" "$excluded" ; then
	    return 1
	else
	    return 0
	fi
    else
	if in_list "$1" "$included" ; then
	    return 0
	else
	    return 1
	fi
    fi
}

# When CAs are discontinued, they (ought to) clean up the symlinks.
# But the CRL files may be left behind. It's always a good idea to remove
# those CRLs which no longer have their CA certificate present.
remove_leftover_crls() {
    for i in /etc/grid-security/certificates/*.r0 ; do
	if [ ! -e /etc/grid-security/certificates/`basename $i`.0 ] ; then
	    rm -f $i
	fi
    done
}

# Earlier versions of this package (<=1.54) did not clean up the symlinks
# of removed CAs
remove_discontinued_cas() {
    discontinued="AIST 075047ca JUnet-CA 3154fd00 IUCC 6fee79b0"
    for i in $discontinued ; do
	for e in crl_url info namespaces pem signing_policy ; do
	    if [ -h /etc/grid-security/certificates/$i.$e ]; then
		rm -f /etc/grid-security/certificates/$i.$e
	    fi
	done
    done
}


case "$1" in
    configure)
	# The configuration works either by exclusion or
	# inclusion of exceptions. If install_profile is
	# 'yes', then all are installed except those listed
	# in exclude_ca; if 'no' then only those in
	# include_ca are installed.

	if [ ! -e /etc/grid-security/certificates ]; then
	    mkdir -p /etc/grid-security/certificates
	fi

	# get the setting of whether to install the profile
	db_get igtf-policy-@PROFILE@/install_profile
	install_profile="$RET"

	# Get the in/exclude lists, replace the commas
	db_get igtf-policy-@PROFILE@/exclude_ca
	excluded=`echo "$RET" | tr ',' ' '`

	db_get igtf-policy-@PROFILE@/include_ca
	included=`echo "$RET" | tr ',' ' '`

	# symlink each file to /etc/grid-security/certificates
	# following the inclusion/exclusion principle described
	# above. The hashed filenames are symlinks to the real
	# names, so they must be resolved with readlink.
	for f in /usr/share/igtf-policy/@PROFILE@/* ; do
            # read the link
	    if [ -h "$f" ]; then
		l=`readlink "$f"`
	    else
		l="$f"
	    fi
	    ca=`basename ${l%.*}`
	    if ca_included $ca; then
                # create symlink if it doesn't exist
		if [ ! -e /etc/grid-security/certificates/`basename $f` ]; then
		    ln -s "$f" /etc/grid-security/certificates/ 
		fi
	    else
                # remove the files, and CRL if any
		rm -f /etc/grid-security/certificates/`basename $f`
		rm -f /etc/grid-security/certificates/`basename ${f#.*}`.r0
	    fi
    	done
	remove_leftover_crls
	if dpkg --compare-versions "$2" lt 1.55 ; then
	    remove_discontinued_cas
	fi
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

#DEBHELPER#

exit 0
